<?xml version="1.0"?>

<sdf version='1.6'>
  <model name="TrolleyBed_ReadOnly">
   <plugin name="readonly" filename="libreadonly.so">
      <!-- Map name where the robot is spawned -->
      <level_name>B1</level_name>
      <!-- Index of navigation graph for the robot as stored in BuildingMap msg -->
      <graph_index>3</graph_index>
      <!-- Name of waypoint where caddy is spawned in the map -->
      <spawn_waypoint>Trolleybed</spawn_waypoint>
      <!-- Number of waypoints to include in predicted path -->
      <look_ahead>6</look_ahead>
      <!-- Update rate (hz) at which robot_state is published -->
      <update_rate>15</update_rate> 
      <!-- Waypoint threshold (m). Radius around the waypoint to determine if caddy is at that waypoint   -->
      <waypoint_threshold>2.0</waypoint_threshold>
      <!-- If true, predicted path will merge robot with nearest lane -->
      <merge_lane>false</merge_lane>
      <!-- Normal distance of robot from its lane, greater than which its path will merge with the lane -->
      <lane_threshold>0.2</lane_threshold>
    </plugin>
    
    
    <!-- Hack: we currently include both Ignition and Gazebo diff drive plugins in the same sdf file, avoiding
    the need to modify it each time we switch simulators. This may result in an error when a simulation engine
    cannot locate the second (unused) plugin, but is ignored for now. -->
    <plugin name="trolleybed_diff_controller" filename="libgazebo_ros_diff_drive.so">
      <always_on>true</always_on>
      <!-- Update rate -->
      <update_rate>100.0</update_rate>
      <!-- Number of wheel pairs -->
      <num_wheel_pairs>1</num_wheel_pairs>
      <!-- wheels -->
      <left_joint>joint_tire_left</left_joint>
      <right_joint>joint_tire_right</right_joint>
      <!-- kinematics -->
      <wheel_separation>1.2</wheel_separation>
      <wheel_separation>1.2</wheel_separation>
      <wheel_diameter>0.64</wheel_diameter>
      <wheel_diameter>0.64</wheel_diameter>
      <!-- limits -->
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <!-- output -->
      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf>
      <publish_wheel_tf>true</publish_wheel_tf>
      <odometry_frame>odom</odometry_frame>
      <robot_base_frame>base_footprint</robot_base_frame>
    </plugin>

    <!-- Note: The forward slash before `libignition-gazebo-diff-drive-system.so` is necessary so that
    `dlopen` in Gazebo Classic interprets it as a pathname and avoids searching LD_LIBRARY_PATH for the
    plugin. If omitted, Gazebo Classic will locate the ignition plugin and crash while attempting to load it. -->
    <plugin name="ignition::gazebo::systems::DiffDrive" filename="/libignition-gazebo-diff-drive-system.so">
      <always_on>true</always_on>
      <update_rate>100.0</update_rate>
      <num_wheel_pairs>2</num_wheel_pairs>
      <left_joint>joint_tire_left</left_joint>
      <right_joint>joint_tire_right</right_joint>
      <wheel_separation>1.2</wheel_separation>
      <wheel_separation>1.2</wheel_separation>
      <wheel_diameter>0.64</wheel_diameter>
      <wheel_diameter>0.64</wheel_diameter>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_torque>150</max_wheel_torque>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <max_wheel_acceleration>0.5</max_wheel_acceleration>
      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf>
      <publish_wheel_tf>true</publish_wheel_tf>
      <odometry_frame>odom</odometry_frame>
      <robot_base_frame>base_footprint</robot_base_frame>
    </plugin>
    
    <link name='base_footprint'>
      <pose frame=''>0 0 0 0 -0 0</pose>
      <inertial>
        <pose frame=''>-0.15 0 0.13 0 -0 0</pose>
        <mass>7</mass> <!-- A higher mass causes wheels to spin while attempting to turn when using DART -->
        <inertia>
          <ixx>0.0594508</ixx>
          <ixy>0</ixy>
          <ixz>-2.77556e-17</ixz>
          <iyy>0.150753</iyy>
          <iyz>0</iyz>
          <izz>0.172704</izz>
        </inertia>
      </inertial>
      
      <visual name="visual">
        <!-- rotate mesh to get to X-forward -->
        <pose frame=''>-0.11 0 0.071 0 -0 0</pose>
        <geometry>
          <mesh>
            <scale>1 1 1</scale>
            <uri>model://TrolleyBed/meshes/TrolleyBed.obj</uri>
          </mesh>
        </geometry>
      </visual>
      
      <collision name="collision">
        <pose frame=''>-0.11 0 0.151 0 -0 0</pose>
        <geometry>
          <mesh>
            <scale>0.8 0.8 0.8</scale>
            <uri>model://TrolleyBed/meshes/TrolleyBed.obj</uri>
          </mesh>
        </geometry>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__base_link_collision_1'>
        <pose frame=''>-0.136 0 0.248 0 -0 0</pose>
        <geometry>
          <box>
            <size>0.375 0.268 0.034</size>
          </box>
        </geometry>
      </collision>
      <collision name='base_footprint_fixed_joint_lump__base_link_collision_2'>
        <pose frame=''>-0.279 0.169 0.106 0 -0 0</pose>
        <geometry>
          <box>
            <size>0.1 0.07 0.07</size>
          </box>
        </geometry>
      </collision>
      <collision name='base_footprint_fixed_joint_lump__base_link_collision_3'>
        <pose frame=''>-0.279 -0.169 0.106 0 -0 0</pose>
        <geometry>
          <box>
            <size>0.1 0.07 0.07</size>
          </box>
        </geometry>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__left_caster_wheel_collision_4'>
        <pose frame=''>-0.3 0.169 0.04 0 -0 0</pose>
        <geometry>
          <sphere>
            <radius>0.04</radius>
          </sphere>
        </geometry>
        <surface>
          <contact>
            <ode>
              <kp>1e+08</kp>
              <min_depth>0.005</min_depth>
            </ode>
          </contact>
          <friction>
            <ode>
              <mu>0</mu>
              <mu2>0</mu2>
            </ode>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__raspicam_collision_5'>
        <pose frame=''>0.05 0.085 0.245 0 -1.15192 3.1415</pose>
        <geometry>
          <box>
            <size>0.03 0.026 0.016</size>
          </box>
        </geometry>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__right_caster_wheel_collision_6'>
        <pose frame=''>-0.3 -0.169 0.04 0 -0 0</pose>
        <geometry>
          <sphere>
            <radius>0.04</radius>
          </sphere>
        </geometry>
        <surface>
          <contact>
            <ode>
              <kp>1e+08</kp>
              <min_depth>0.005</min_depth>
            </ode>
          </contact>
          <friction>
            <ode>
              <mu>0</mu>
              <mu2>0</mu2>
            </ode>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__sonar_0_collision_7'>
        <pose frame=''>0.01 -0.14 0.25 0 0 -1.5708</pose>
        <geometry>
          <box>
            <size>0.02 0.044 0.021</size>
          </box>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__sonar_1_collision_8'>
        <pose frame=''>0.08 -0.07 0.25 0 -0 0.785</pose>
        <geometry>
          <box>
            <size>0.02 0.044 0.021</size>
          </box>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__sonar_2_collision_9'>
        <pose frame=''>0.08 -0.01 0.25 0 0 -0.785</pose>
        <geometry>
          <box>
            <size>0.02 0.044 0.021</size>
          </box>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__sonar_3_collision_10'>
        <pose frame=''>0.08 0.04 0.25 0 -0 0</pose>
        <geometry>
          <box>
            <size>0.02 0.044 0.021</size>
          </box>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>
      
      <collision name='base_footprint_fixed_joint_lump__sonar_4_collision_11'>
        <pose frame=''>0.01 0.14 0.25 0 -0 1.5708</pose>
        <geometry>
          <box>
            <size>0.02 0.044 0.021</size>
          </box>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>
      </link>
      
    <link name='left_wheel'>
      <pose frame=''>0 0.163 0.1 0 -0 1.5708</pose>
      <inertial>
        <pose frame=''>0 0 0 3.14159 1.57079 3.14159</pose>
        <mass>3.34</mass>
        <inertia>
          <ixx>0.00904583</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.00904583</iyy>
          <iyz>0</iyz>
          <izz>0.0167</izz>
        </inertia>
      </inertial>     
      <collision name='left_wheel_collision'>
        <pose frame=''>0 0 0 3.14159 1.57079 3.14159</pose>
        <geometry>
          <sphere>
            <radius>0.1</radius>
          </sphere>
        </geometry>
        <surface>
          <contact>
            <ode>
            <!--
              <kp>1e+08</kp>
              <min_depth>0.005</min_depth>
              -->
              <kp>10000000.0</kp>
              <kd>1.0</kd>
            </ode>
          </contact>
          <friction>
            <ode>
              <mu>1</mu>
              <mu2>1</mu2>
              <fdir1>0 0 1</fdir1>
            </ode>
          </friction>
        </surface>
      </collision>
      <gravity>1</gravity>
      <!--velocity_decay/-->
    </link>
    
    <joint name='joint_tire_left' type='revolute'>
      <child>left_wheel</child>
      <parent>base_footprint</parent>
      <axis>
        <xyz>0 1 0</xyz>
        <use_parent_model_frame>true</use_parent_model_frame>
      </axis>
      <physics>
        <ode>
          <limit>
            <cfm>0.000000</cfm>
            <erp>0.900000</erp>
          </limit>
        </ode>
      </physics>
    </joint>
    
    <link name='right_wheel'>
      <pose frame=''>0 -0.163 0.1 0 -0 1.5708</pose>
      <inertial>
        <pose frame=''>0 0 0 3.14159 1.57079 3.14159</pose>
        <mass>3.34</mass>
        <inertia>
          <ixx>0.00904583</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.00904583</iyy>
          <iyz>0</iyz>
          <izz>0.0167</izz>
        </inertia>
      </inertial>
      <collision name='right_wheel_collision'>
        <pose frame=''>0 0 0 3.14159 1.57079 3.14159</pose>
        <geometry>
          <sphere>
            <radius>0.1</radius>
          </sphere>
        </geometry>
        <surface>
          <contact>
            <ode>
            <!--
              <kp>1e+08</kp>
              <min_depth>0.005</min_depth>
              -->
              <kp>10000000.0</kp>
              <kd>1.0</kd>
            </ode>
          </contact>
          <friction>
            <ode>
              <mu>1</mu>
              <mu2>1</mu2>
              <fdir1>0 0 1</fdir1>
            </ode>
          </friction>
        </surface>
      </collision>
      <gravity>1</gravity>
      <!--velocity_decay/-->
    </link>
    
    <joint name='joint_tire_right' type='revolute'>
      <child>right_wheel</child>
      <parent>base_footprint</parent>
      <axis>
        <xyz>0 1 0</xyz>
        <use_parent_model_frame>true</use_parent_model_frame>
      </axis>
      <physics>
        <ode>
          <limit>
            <cfm>0.000000</cfm>
            <erp>0.900000</erp>
          </limit>
        </ode>
      </physics>
    </joint>
    
  </model>
</sdf>
